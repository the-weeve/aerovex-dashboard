<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerovex Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafbfc;
            color: #1a1d29;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body.dark-mode {
            background: #0f1419;
            color: #e5e7eb;
        }
        
        body.dark-mode .topbar {
            background: rgba(17, 24, 39, 0.95);
            border-bottom-color: #374151;
        }
        
        body.dark-mode .logo {
            filter: brightness(0) invert(1);
        }
        
        body.dark-mode .settings-btn,
        body.dark-mode .dark-mode-toggle {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        
        body.dark-mode .settings-btn:hover,
        body.dark-mode .dark-mode-toggle:hover {
            background: #4b5563;
        }
        
        body.dark-mode .tab {
            color: #9ca3af;
        }
        
        body.dark-mode .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        body.dark-mode .upload-section {
            background: #1f2937;
            border-color: #374151;
        }
        
        body.dark-mode .upload-section.active {
            background: #1e3a5f;
            border-color: #3b82f6;
        }
        
        body.dark-mode .page-title,
        body.dark-mode .section-title {
            color: #f9fafb;
        }
        
        body.dark-mode .page-subtitle {
            color: #9ca3af;
        }
        
        body.dark-mode .metric-card,
        body.dark-mode .stat-card,
        body.dark-mode .chart-section,
        body.dark-mode .platform-card {
            background: #1f2937;
            border-color: #374151;
        }
        
        body.dark-mode .metric-card:hover,
        body.dark-mode .stat-card:hover,
        body.dark-mode .chart-section:hover {
            border-color: #4b5563;
        }
        
        body.dark-mode .metric-value,
        body.dark-mode .stat-value,
        body.dark-mode .platform-value {
            color: #f9fafb;
        }
        
        body.dark-mode .stat-card-header,
        body.dark-mode .platform-name {
            color: #9ca3af;
        }
        
        body.dark-mode .stat-row {
            border-bottom-color: #374151;
        }
        
        body.dark-mode .margin-selector select {
            background: #374151;
            color: #e5e7eb;
            border-color: #4b5563;
        }
        
        body.dark-mode .file-name {
            color: #9ca3af;
        }
        
        body.dark-mode table {
            color: #e5e7eb;
        }
        
        body.dark-mode th {
            background: #374151 !important;
            color: #9ca3af !important;
        }
        
        body.dark-mode td {
            border-bottom-color: #374151 !important;
        }
        
        body.dark-mode .status-badge {
            opacity: 0.9;
        }
        
        .topbar {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 24px 40px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .topbar-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .topbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .dark-mode-toggle {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 38px;
        }
        
        .dark-mode-toggle:hover {
            background: #e5e7eb;
        }
        
        .logo {
            height: 40px;
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 100%;
            width: auto;
        }
        
        .settings-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1a1d29;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
            height: 38px;
            display: flex;
            align-items: center;
        }
        
        .settings-btn:hover {
            background: #e5e7eb;
        }
        
        .margin-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            height: 38px;
        }
        
        .margin-selector label {
            color: #6b7280;
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            line-height: 1;
        }
        
        .margin-selector select {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #1a1d29;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            outline: none;
            line-height: 1;
        }
        
        .margin-selector select:hover {
            border-color: #3b82f6;
        }
        
        body.dark-mode .margin-selector {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode .margin-selector label {
            color: #9ca3af;
        }
        
        body.dark-mode .margin-selector select {
            background: #1f2937;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        
        .tabs {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 32px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        body.dark-mode .tabs {
            border-bottom-color: #374151;
        }
        
        .tab {
            padding: 12px 0;
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            user-select: none;
        }
        
        .tab:hover {
            color: #1a1d29;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-section {
            background: #ffffff;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 32px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .upload-section.active {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .upload-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            font-family: 'Outfit', sans-serif;
            margin-top: 12px;
            margin-right: 8px;
        }
        
        .upload-btn:hover {
            background: #2563eb;
        }
        
        .file-name {
            margin-top: 12px;
            font-size: 13px;
            color: #6b7280;
            font-style: italic;
        }
        
        .margin-selector {
            margin-top: 24px;
        }
        
        .margin-selector label {
            font-size: 14px;
            font-weight: 500;
            color: #1a1d29;
            margin-right: 12px;
        }
        
        .margin-selector select {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            background: white;
            cursor: pointer;
        }
        
        .page-header {
            margin-bottom: 40px;
            animation: fadeIn 0.6s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .page-header-text {
            flex: 1;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: 600;
            color: #1a1d29;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .page-subtitle {
            font-size: 15px;
            color: #6b7280;
            font-weight: 400;
        }
        
        .tab-margin-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            height: 38px;
        }
        
        .tab-margin-selector label {
            color: #6b7280;
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .tab-margin-selector select {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #1a1d29;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            outline: none;
        }
        
        body.dark-mode .tab-margin-selector {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-mode .tab-margin-selector label {
            color: #9ca3af;
        }
        
        body.dark-mode .tab-margin-selector select {
            background: #1f2937;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeIn 0.8s ease-out 0.1s both;
        }
        
        .metric-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: #d1d5db;
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
        }
        
        .metric-card:hover::before {
            transform: scaleX(1);
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 600;
            color: #1a1d29;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
        }
        
        .metric-subtext {
            font-size: 13px;
            color: #9ca3af;
            font-weight: 400;
        }
        
        .positive {
            color: #10b981;
        }
        
        .negative {
            color: #ef4444;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #1a1d29;
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }
        
        .chart-section {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
            animation: fadeIn 0.8s ease-out 0.3s both;
        }
        
        .chart-section h2 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1d29;
            margin-bottom: 28px;
            letter-spacing: -0.01em;
        }
        
        .chart-container {
            position: relative;
            height: 380px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 28px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: #d1d5db;
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
        }
        
        .stat-card-header {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }
        
        .stat-value {
            font-size: 16px;
            color: #1a1d29;
            font-weight: 600;
        }
        
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .platform-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .platform-card:hover {
            transform: translateY(-2px);
            border-color: #d1d5db;
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.08);
        }
        
        .platform-name {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .platform-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a1d29;
            margin-bottom: 8px;
        }
        
        .platform-subtext {
            font-size: 13px;
            color: #9ca3af;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }
        
        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            text-transform: uppercase;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-excellent { background: #d1fae5; color: #065f46; }
        .status-good { background: #dbeafe; color: #1e40af; }
        .status-okay { background: #fef3c7; color: #92400e; }
        .status-poor { background: #fee2e2; color: #991b1b; }
        
        .dashboard-content {
            display: none;
        }
        
        .dashboard-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 24px 20px;
            }
            
            .topbar {
                padding: 20px 20px 0;
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                gap: 16px;
            }
        }
        
        /* Chat Interface Styles */
        .chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            font-family: 'Outfit', sans-serif;
        }
        
        .chat-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(59, 130, 246, 0.5);
        }
        
        .chat-toggle.active {
            background: #6b7280;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .chat-icon {
            font-size: 18px;
        }
        
        .chat-panel {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 380px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
        }
        
        .chat-panel.open {
            display: flex;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        body.dark-mode .chat-panel {
            background: #1f2937;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 15px;
        }
        
        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .chat-message.user {
            background: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: #f3f4f6;
            color: #1a1d29;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        body.dark-mode .chat-message.assistant {
            background: #374151;
            color: #e5e7eb;
        }
        
        .chat-message.assistant .message-content ul {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }
        
        .chat-message.assistant .message-content li {
            margin: 4px 0;
        }
        
        .chat-message.loading .message-content::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #9ca3af;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .chat-input-area {
            padding: 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 8px;
        }
        
        body.dark-mode .chat-input-area {
            border-top-color: #374151;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            font-family: 'Outfit', sans-serif;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            border-color: #3b82f6;
        }
        
        body.dark-mode .chat-input {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        
        .chat-send {
            width: 44px;
            height: 44px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .chat-send:hover {
            background: #2563eb;
        }
        
        .chat-send:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        @media (max-width: 480px) {
            .chat-panel {
                width: calc(100% - 32px);
                right: 16px;
                bottom: 80px;
                height: 60vh;
            }
            
            .chat-toggle {
                right: 16px;
                bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-content">
            <div class="logo">
                <img src="logo.png" alt="Aerovex Systems">
                <span style="margin-left: 12px; font-size: 12px; color: #9ca3af; font-weight: 500;">v1.0</span>
            </div>
            <div class="topbar-actions">
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeBtn">ðŸŒ™</button>
                <button class="settings-btn" onclick="toggleUpload()">Upload Data</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('business')">Total Business Overview</div>
            <div class="tab" onclick="switchTab('campaigns')">Ad Campaign Performance</div>
            <div class="tab" onclick="switchTab('trends')">Monthly Trends</div>
            <div class="tab" onclick="switchTab('forecast')">Forecasting</div>
            <div class="tab" onclick="switchTab('summary')">Executive Summary</div>
        </div>
    </div>
    
    <div class="container">
        <!-- Campaign Performance Tab -->
        <div class="tab-content" id="campaignsTab">
            <div class="upload-section" id="campaignUploadSection">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">Upload Campaign Data</h2>
                <p style="color: #6b7280; margin-bottom: 24px;">Upload your combined Ad Campaign CSV (includes both Meta and Google data)</p>
                
                <input type="file" id="campaignFile" accept=".csv" style="display: none;" onchange="handleCampaignUpload(event)">
                <label for="campaignFile" class="upload-btn">Ad Campaign CSV</label>
                <div class="file-name" id="campaignFileName">No file selected</div>
            </div>
            
            <div class="dashboard-content" id="campaignDashboardContent">
                <div class="page-header">
                    <div class="page-header-text">
                        <h1 class="page-title">Ad Campaign Performance</h1>
                        <p class="page-subtitle" id="campaignPageSubtitle"></p>
                    </div>
                    <div class="tab-margin-selector">
                        <label for="campaignMargin">Margin:</label>
                        <select id="campaignMargin" onchange="updateAllTabs()">
                            <option value="0.30">30%</option>
                            <option value="0.35">35%</option>
                            <option value="0.40">40%</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50%</option>
                            <option value="0.55">55%</option>
                            <option value="0.60" selected>60%</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title">Overview</h2>
                <div class="metrics-grid" id="campaignMetrics"></div>
                
                <h2 class="section-title">Platform Performance</h2>
                <div class="platform-grid" id="platformMetrics"></div>
                
                <div class="chart-section">
                    <h2>Campaign Performance Map</h2>
                    <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Bubble size = Ad Spend â€¢ Right & up = better performance â€¢ Green = profitable</p>
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="campaignBubbleChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Profit by Campaign</h2>
                    <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Net profit after ad spend at current margin</p>
                    <div class="chart-container">
                        <canvas id="campaignProfitChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Spend Efficiency</h2>
                    <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">Share of spend vs share of revenue â€” bars going right = efficient</p>
                    <div class="chart-container">
                        <canvas id="spendEfficiencyChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Campaign Performance Table</h2>
                    <table id="campaignTable"></table>
                </div>
                
                <div class="chart-section">
                    <h2>Budget Allocation Recommendations</h2>
                    <p style="color: #6b7280; margin-bottom: 24px;">Based on campaign performance, here's how to optimize your budget allocation:</p>
                    <div id="budgetRecommendations"></div>
                </div>
            </div>
        </div>
        
        <!-- Business Overview Tab -->
        <div class="tab-content active" id="businessTab">
            <div class="upload-section" id="businessUploadSection">
                <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 12px;">Upload Business Data</h2>
                <p style="color: #6b7280; margin-bottom: 24px;">Upload your monthly business metrics CSV</p>
                
                <input type="file" id="businessFile" accept=".csv" style="display: none;" onchange="handleBusinessUpload(event)">
                <label for="businessFile" class="upload-btn">Choose CSV File</label>
                <div class="file-name" id="businessFileName">No file selected</div>
            </div>
            
            <div class="dashboard-content" id="businessDashboardContent">
                <div class="page-header">
                    <div class="page-header-text">
                        <h1 class="page-title">Total Business Overview</h1>
                        <p class="page-subtitle" id="businessPageSubtitle"></p>
                    </div>
                    <div class="tab-margin-selector">
                        <label for="businessMargin">Margin:</label>
                        <select id="businessMargin" onchange="updateAllTabs()">
                            <option value="0.30">30%</option>
                            <option value="0.35">35%</option>
                            <option value="0.40">40%</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50%</option>
                            <option value="0.55">55%</option>
                            <option value="0.60" selected>60%</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title" id="currentMonthTitle">Current Month Performance</h2>
                <div class="metrics-grid" id="businessMetrics"></div>
                
                <h2 class="section-title" style="margin-top: 40px;">Advertising Performance</h2>
                <div class="chart-section">
                    <table id="adComparisonTable" style="width: 100%; border-collapse: collapse;"></table>
                    <p id="breakevenNote" style="color: #6b7280; margin-top: 16px; font-size: 13px;"></p>
                </div>
                
                <h2 class="section-title">Sales Breakdown</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">Website Sales</div>
                        <div id="websiteStats"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">Lucas Sales</div>
                        <div id="lucasStats"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">Affiliate Sales</div>
                        <div id="affiliateStats"></div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Monthly Revenue Trends</h2>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Ad Spend & Revenue</h2>
                    <div class="chart-container">
                        <canvas id="adChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Website Traffic</h2>
                    <div class="chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monthly Trends Tab -->
        <div class="tab-content" id="trendsTab">
            <div class="dashboard-content active" id="trendsDashboardContent">
                <div class="page-header">
                    <div class="page-header-text">
                        <h1 class="page-title">Monthly Trends</h1>
                        <p class="page-subtitle" id="trendsPageSubtitle">Month-over-month performance changes</p>
                    </div>
                    <div class="tab-margin-selector">
                        <label for="trendsMargin">Margin:</label>
                        <select id="trendsMargin" onchange="updateAllTabs()">
                            <option value="0.30">30%</option>
                            <option value="0.35">35%</option>
                            <option value="0.40">40%</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50%</option>
                            <option value="0.55">55%</option>
                            <option value="0.60" selected>60%</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title">This Month vs Last Month</h2>
                <div class="metrics-grid" id="trendsMetrics"></div>
                
                <div class="chart-section">
                    <h2>Revenue Trend</h2>
                    <div class="chart-container">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>ROAS Trend</h2>
                    <div class="chart-container">
                        <canvas id="roasTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Traffic Trend</h2>
                    <div class="chart-container">
                        <canvas id="trafficTrendChart"></canvas>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>Monthly Performance Summary</h2>
                    <table id="trendsSummaryTable"></table>
                </div>
            </div>
        </div>
        
        <!-- Forecasting Tab -->
        <div class="tab-content" id="forecastTab">
            <div class="dashboard-content active" id="forecastDashboardContent">
                <div class="page-header">
                    <div class="page-header-text">
                        <h1 class="page-title">Forecasting</h1>
                        <p class="page-subtitle" id="forecastPageSubtitle">Current month projections based on daily averages</p>
                    </div>
                    <div class="tab-margin-selector">
                        <label for="forecastMargin">Margin:</label>
                        <select id="forecastMargin" onchange="updateAllTabs()">
                            <option value="0.30">30%</option>
                            <option value="0.35">35%</option>
                            <option value="0.40">40%</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50%</option>
                            <option value="0.55">55%</option>
                            <option value="0.60" selected>60%</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title">Month Progress</h2>
                <div class="chart-section" style="margin-bottom: 32px;">
                    <div id="progressContainer" style="margin-bottom: 24px;"></div>
                </div>
                
                <h2 class="section-title">On Pace For</h2>
                <div class="metrics-grid" id="forecastMetrics"></div>
                
                <h2 class="section-title">Current vs Projected</h2>
                <div class="chart-section">
                    <div id="projectionDetails"></div>
                </div>
            </div>
        </div>
        
        <!-- Executive Summary Tab -->
        <div class="tab-content" id="summaryTab">
            <div class="dashboard-content active" id="summaryDashboardContent">
                <div class="page-header">
                    <div class="page-header-text">
                        <h1 class="page-title">Executive Summary</h1>
                        <p class="page-subtitle" id="summaryPageSubtitle">Quick overview of business health</p>
                    </div>
                    <div class="tab-margin-selector">
                        <label for="summaryMargin">Margin:</label>
                        <select id="summaryMargin" onchange="updateAllTabs()">
                            <option value="0.30">30%</option>
                            <option value="0.35">35%</option>
                            <option value="0.40">40%</option>
                            <option value="0.45">45%</option>
                            <option value="0.50">50%</option>
                            <option value="0.55">55%</option>
                            <option value="0.60" selected>60%</option>
                        </select>
                    </div>
                </div>
                
                <h2 class="section-title">Key Metrics</h2>
                <div class="metrics-grid" id="summaryMetrics"></div>
                
                <h2 class="section-title">On Pace For (End of Month)</h2>
                <div class="metrics-grid" id="summaryForecast"></div>
                
                <h2 class="section-title">Business Health</h2>
                <div class="chart-section">
                    <div style="max-width: 500px; margin: 0 auto;">
                        <canvas id="healthRadarChart"></canvas>
                    </div>
                </div>
                
                <h2 class="section-title">Insights</h2>
                <div class="chart-section">
                    <div id="summaryInsights"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Chat Interface -->
    <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">
        <span class="chat-icon">ðŸ’¬</span>
        <span class="chat-label">Ask AI</span>
    </button>
    
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="chat-header-title">
                <span style="font-size: 18px;">âœ¨</span>
                <span>Dashboard Assistant</span>
            </div>
            <button class="chat-close" onclick="toggleChat()">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="message-content">Hey! I can help you understand your dashboard data. Try asking things like:
                    <ul style="margin: 8px 0 0 16px; padding: 0;">
                        <li>How are my ads performing?</li>
                        <li>Which channel is most profitable?</li>
                        <li>What should I focus on?</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your data..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send" id="chatSend" onclick="sendChatMessage()">â†’</button>
        </div>
    </div>
    
    <script>
        // Global variables
        let metaData = null;
        let googleData = null;
        let businessData = null;
        let campaignBubbleChart = null;
        let campaignProfitChart = null;
        let spendEfficiencyChart = null;
        let revenueChart = null;
        let adChart = null;
        let healthRadarChart = null;
        let trafficChart = null;
        let revenueTrendChart = null;
        let roasTrendChart = null;
        let trafficTrendChart = null;
        
        // Tab switching
        function switchTab(tabName) {
            // Update tab styling
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'campaigns') {
                document.getElementById('campaignsTab').classList.add('active');
            } else if (tabName === 'business') {
                document.getElementById('businessTab').classList.add('active');
            } else if (tabName === 'trends') {
                document.getElementById('trendsTab').classList.add('active');
                if (businessData) {
                    updateTrendsDashboard();
                }
            } else if (tabName === 'forecast') {
                document.getElementById('forecastTab').classList.add('active');
                if (businessData) {
                    updateForecastDashboard();
                }
            } else if (tabName === 'summary') {
                document.getElementById('summaryTab').classList.add('active');
                if (businessData) {
                    updateSummaryDashboard();
                }
            }
        }
        
        // Dark mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeBtn').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            
            // Update charts
            updateCampaignChartColors();
            updateBusinessChartColors();
            updateTrendsChartColors();
            if (businessData) {
                updateSummaryDashboard();
            }
        }
        
        function updateAllTabs() {
            // Get the margin from the selector that triggered this
            const newMargin = event.target.value;
            
            // Sync all margin selectors to the same value
            const marginSelectors = ['businessMargin', 'campaignMargin', 'trendsMargin', 'forecastMargin', 'summaryMargin'];
            marginSelectors.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = newMargin;
            });
            
            // Update all dashboards
            if (metaData && googleData) {
                updateCampaignDashboard();
            }
            if (businessData) {
                updateBusinessDashboard();
                updateTrendsDashboard();
                updateForecastDashboard();
                updateSummaryDashboard();
            }
        }
        
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            document.getElementById('darkModeBtn').textContent = 'â˜€ï¸';
        }
        
        function updateCampaignChartColors() {
            if (metaData && googleData) {
                createCampaignCharts();
            }
        }
        
        function updateBusinessChartColors() {
            if (businessData) {
                createBusinessCharts();
            }
        }
        
        function updateTrendsChartColors() {
            if (businessData) {
                createTrendsCharts();
            }
        }
        
        // Upload toggle
        function toggleUpload() {
            const activeTab = document.querySelector('.tab.active').textContent;
            if (activeTab.includes('Campaign')) {
                const section = document.getElementById('campaignUploadSection');
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
            } else {
                const section = document.getElementById('businessUploadSection');
                section.style.display = section.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Utility functions
        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // ==========================================
        // CAMPAIGN PERFORMANCE CODE
        // ==========================================
        
        function handleCampaignUpload(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('campaignFileName').textContent = file.name;
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        const parsed = parseCombinedCampaignData(results.data);
                        metaData = parsed.metaData;
                        googleData = parsed.googleData;
                        if (metaData && googleData) {
                            document.getElementById('campaignUploadSection').style.display = 'none';
                            updateCampaignDashboard();
                        }
                    }
                });
            }
        }
        
        function parseCombinedCampaignData(data) {
            const metaCampaigns = [];
            const googleCampaigns = [];
            let startDate = null;
            let endDate = null;
            
            data.forEach(row => {
                const platform = row['Platform']?.trim().toLowerCase();
                const campaignName = row['Campaign Name']?.trim();
                
                // Capture date range from first row that has it
                if (!startDate && row['Start Date']) {
                    startDate = row['Start Date'];
                }
                if (row['End Date']) {
                    endDate = row['End Date'];
                }
                
                if (campaignName && campaignName !== '') {
                    const campaign = {
                        name: campaignName,
                        spend: parseFloat(row['Cost']?.replace(/[$,]/g, '')) || 0,
                        revenue: parseFloat(row['Revenue']?.replace(/[$,]/g, '')) || 0,
                        clicks: parseInt(row['Clicks']?.replace(/,/g, '')) || 0
                    };
                    
                    if (platform === 'meta') {
                        metaCampaigns.push(campaign);
                    } else if (platform === 'google') {
                        googleCampaigns.push(campaign);
                    }
                }
            });
            
            // Default to current month if no dates provided
            if (!startDate || !endDate) {
                const now = new Date();
                startDate = `${now.getMonth() + 1}/1/${now.getFullYear()}`;
                endDate = `${now.getMonth() + 1}/${now.getDate()}/${now.getFullYear()}`;
            }
            
            return {
                metaData: { campaigns: metaCampaigns, startDate, endDate },
                googleData: { campaigns: googleCampaigns }
            };
        }
        
        // Keep legacy parsers for backwards compatibility with old CSV formats
        function parseMetaData(data) {
            const campaigns = [];
            let startDate = null;
            let endDate = null;
            
            data.forEach(row => {
                if (row['Campaign name'] && row['Campaign name'].trim() !== '') {
                    if (!startDate) startDate = row['Reporting starts'];
                    endDate = row['Reporting ends'];
                    
                    campaigns.push({
                        name: row['Campaign name'],
                        spend: parseFloat(row['Amount spent (USD)']?.replace(/,/g, '')) || 0,
                        revenue: parseFloat(row['Purchases conversion value']?.replace(/,/g, '')) || 0,
                        purchases: parseInt(row['Results']) || 0,
                        clicks: parseInt(row['Clicks (all)']) || 0
                    });
                }
            });
            
            return { campaigns, startDate, endDate };
        }
        
        function parseGoogleData(data) {
            const campaigns = [];
            
            data.forEach(row => {
                if (row['Campaign Name'] && row['Campaign Name'].trim() !== '') {
                    campaigns.push({
                        name: row['Campaign Name'],
                        spend: parseFloat(row['Cost']?.replace(/[$,]/g, '')) || 0,
                        revenue: parseFloat(row['Conv. value']?.replace(/[$,]/g, '')) || 0,
                        clicks: parseInt(row['Clicks']?.replace(/,/g, '')) || 0
                    });
                }
            });
            
            return { campaigns };
        }
        
        function calculateCampaignMetrics() {
            if (!metaData || !googleData) return null;
            
            const margin = parseFloat(document.getElementById('campaignMargin').value);
            const breakevenRoas = 1 / margin;
            
            const allCampaigns = [
                ...metaData.campaigns.map(c => ({ ...c, platform: 'Meta' })),
                ...googleData.campaigns.map(c => ({ ...c, platform: 'Google' }))
            ];
            
            const totalSpend = allCampaigns.reduce((sum, c) => sum + c.spend, 0);
            const totalRevenue = allCampaigns.reduce((sum, c) => sum + c.revenue, 0);
            const totalClicks = allCampaigns.reduce((sum, c) => sum + c.clicks, 0);
            const totalPurchases = metaData.campaigns.reduce((sum, c) => sum + c.purchases, 0);
            
            const roas = totalSpend > 0 ? totalRevenue / totalSpend : 0;
            const grossProfit = totalRevenue * margin;
            const netProfit = grossProfit - totalSpend;
            
            const metaSpend = metaData.campaigns.reduce((sum, c) => sum + c.spend, 0);
            const metaRevenue = metaData.campaigns.reduce((sum, c) => sum + c.revenue, 0);
            const metaRoas = metaSpend > 0 ? metaRevenue / metaSpend : 0;
            
            const googleSpend = googleData.campaigns.reduce((sum, c) => sum + c.spend, 0);
            const googleRevenue = googleData.campaigns.reduce((sum, c) => sum + c.revenue, 0);
            const googleRoas = googleSpend > 0 ? googleRevenue / googleSpend : 0;
            
            const startDate = new Date(metaData.startDate);
            const endDate = new Date(metaData.endDate);
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            return {
                total: { spend: totalSpend, revenue: totalRevenue, roas, grossProfit, netProfit, clicks: totalClicks, purchases: totalPurchases },
                meta: { spend: metaSpend, revenue: metaRevenue, roas: metaRoas },
                google: { spend: googleSpend, revenue: googleRevenue, roas: googleRoas },
                breakevenRoas,
                margin,
                days,
                dateRange: `${formatDate(metaData.startDate)} - ${formatDate(metaData.endDate)}`
            };
        }
        
        function updateCampaignDashboard() {
            const metrics = calculateCampaignMetrics();
            if (!metrics) return;
            
            const margin = parseFloat(document.getElementById('campaignMargin').value);
            
            document.getElementById('campaignDashboardContent').classList.add('active');
            document.getElementById('campaignPageSubtitle').textContent = 
                `${metrics.dateRange} â€¢ ${(margin * 100)}% profit margin â€¢ ${metrics.total.roas.toFixed(2)}x blended ROAS`;
            
            // Overview metrics
            let metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Ad Spend</div>
                    <div class="metric-value">${formatCurrency(metrics.total.spend)}</div>
                    <div class="metric-subtext">${formatCurrency(metrics.total.spend / metrics.days)}/day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Ad Revenue</div>
                    <div class="metric-value">${formatCurrency(metrics.total.revenue)}</div>
                    <div class="metric-subtext">${formatCurrency(metrics.total.revenue / metrics.days)}/day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ROAS</div>
                    <div class="metric-value">${metrics.total.roas.toFixed(2)}x</div>
                    <div class="metric-subtext">Break-even: ${metrics.breakevenRoas.toFixed(1)}x</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Net Profit</div>
                    <div class="metric-value positive">${formatCurrency(metrics.total.netProfit)}</div>
                    <div class="metric-subtext">${formatCurrency(metrics.total.netProfit / metrics.days)}/day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Ad Clicks</div>
                    <div class="metric-value">${metrics.total.clicks.toLocaleString()}</div>
                    <div class="metric-subtext">${metrics.total.purchases} purchases</div>
                </div>
            `;
            document.getElementById('campaignMetrics').innerHTML = metricsHTML;
            
            // Platform metrics
            let platformHTML = `
                <div class="platform-card">
                    <div class="platform-name">Meta Ads</div>
                    <div class="platform-value">${metrics.meta.roas.toFixed(2)}x</div>
                    <div class="platform-subtext">${formatCurrency(metrics.meta.revenue)} revenue</div>
                </div>
                <div class="platform-card">
                    <div class="platform-name">Google Ads</div>
                    <div class="platform-value">${metrics.google.roas.toFixed(2)}x</div>
                    <div class="platform-subtext">${formatCurrency(metrics.google.revenue)} revenue</div>
                </div>
            `;
            document.getElementById('platformMetrics').innerHTML = platformHTML;
            
            // Campaign table
            const allCampaigns = [
                ...metaData.campaigns.map(c => ({ ...c, platform: 'Meta' })),
                ...googleData.campaigns.map(c => ({ ...c, platform: 'Google' }))
            ].sort((a, b) => (b.revenue / b.spend) - (a.revenue / a.spend));
            
            let tableHTML = '<thead><tr><th>Campaign</th><th>Platform</th><th>Spend</th><th>Revenue</th><th>ROAS</th><th>Status</th></tr></thead><tbody>';
            allCampaigns.forEach(camp => {
                const roas = camp.spend > 0 ? camp.revenue / camp.spend : 0;
                let statusClass = 'status-poor';
                let statusText = 'Poor';
                
                if (roas >= metrics.breakevenRoas * 2) {
                    statusClass = 'status-excellent';
                    statusText = 'Excellent';
                } else if (roas >= metrics.breakevenRoas * 1.5) {
                    statusClass = 'status-good';
                    statusText = 'Good';
                } else if (roas >= metrics.breakevenRoas) {
                    statusClass = 'status-okay';
                    statusText = 'Okay';
                }
                
                tableHTML += `
                    <tr>
                        <td style="font-weight: 500;">${camp.name}</td>
                        <td>${camp.platform}</td>
                        <td>${formatCurrency(camp.spend)}</td>
                        <td>${formatCurrency(camp.revenue)}</td>
                        <td><strong>${roas.toFixed(2)}x</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            tableHTML += '</tbody>';
            document.getElementById('campaignTable').innerHTML = tableHTML;
            
            // Budget recommendations
            generateBudgetRecommendations(allCampaigns, metrics);
            
            // Charts
            createCampaignCharts();
        }
        
        function createCampaignCharts() {
            if (!metaData || !googleData) return;
            
            const metrics = calculateCampaignMetrics();
            const allCampaigns = [
                ...metaData.campaigns.map(c => ({ ...c, platform: 'Meta' })),
                ...googleData.campaigns.map(c => ({ ...c, platform: 'Google' }))
            ].sort((a, b) => (b.revenue / b.spend) - (a.revenue / a.spend));
            
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#374151' : '#f3f4f6';
            const textColor = isDark ? '#9ca3af' : '#6b7280';
            
            Chart.defaults.font.family = "'Outfit', sans-serif";
            Chart.defaults.color = textColor;
            
            // Filter campaigns by platform
            const metaCampaigns = allCampaigns.filter(c => c.platform === 'Meta');
            const googleCampaigns = allCampaigns.filter(c => c.platform === 'Google');
            
            // Find max spend for bubble scaling
            const maxSpend = Math.max(...allCampaigns.map(c => c.spend));
            const minBubble = 8;
            const maxBubble = 40;
            
            // Bubble Chart - Campaign Performance Map
            if (campaignBubbleChart) campaignBubbleChart.destroy();
            const bubbleCtx = document.getElementById('campaignBubbleChart').getContext('2d');
            
            // Create bubble data for each platform
            const metaBubbles = metaCampaigns.map(c => ({
                x: c.spend > 0 ? c.revenue / c.spend : 0,
                y: c.revenue,
                r: minBubble + ((c.spend / maxSpend) * (maxBubble - minBubble)),
                name: c.name,
                spend: c.spend,
                roas: c.spend > 0 ? c.revenue / c.spend : 0,
                profit: (c.revenue * metrics.margin) - c.spend
            }));
            
            const googleBubbles = googleCampaigns.map(c => ({
                x: c.spend > 0 ? c.revenue / c.spend : 0,
                y: c.revenue,
                r: minBubble + ((c.spend / maxSpend) * (maxBubble - minBubble)),
                name: c.name,
                spend: c.spend,
                roas: c.spend > 0 ? c.revenue / c.spend : 0,
                profit: (c.revenue * metrics.margin) - c.spend
            }));
            
            campaignBubbleChart = new Chart(bubbleCtx, {
                type: 'bubble',
                data: {
                    datasets: [
                        {
                            label: 'Meta',
                            data: metaBubbles,
                            backgroundColor: metaBubbles.map(b => 
                                b.roas >= metrics.breakevenRoas ? 'rgba(139, 92, 246, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                            ),
                            borderColor: metaBubbles.map(b => 
                                b.roas >= metrics.breakevenRoas ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
                            ),
                            borderWidth: 3
                        },
                        {
                            label: 'Google',
                            data: googleBubbles,
                            backgroundColor: googleBubbles.map(b => 
                                b.roas >= metrics.breakevenRoas ? 'rgba(59, 130, 246, 0.6)' : 'rgba(239, 68, 68, 0.6)'
                            ),
                            borderColor: googleBubbles.map(b => 
                                b.roas >= metrics.breakevenRoas ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
                            ),
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const data = context.raw;
                                    const profitStr = data.profit >= 0 
                                        ? `+$${data.profit.toLocaleString(undefined, {maximumFractionDigits: 0})}` 
                                        : `-$${Math.abs(data.profit).toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                                    return [
                                        data.name,
                                        `ROAS: ${data.roas.toFixed(2)}x`,
                                        `Revenue: $${data.y.toLocaleString(undefined, {maximumFractionDigits: 0})}`,
                                        `Spend: $${data.spend.toLocaleString(undefined, {maximumFractionDigits: 0})}`,
                                        `Profit: ${profitStr}`
                                    ];
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                breakeven: {
                                    type: 'line',
                                    xMin: metrics.breakevenRoas,
                                    xMax: metrics.breakevenRoas,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: 'Break-even',
                                        position: 'start',
                                        backgroundColor: '#ef4444',
                                        color: 'white',
                                        padding: 6,
                                        font: { size: 11, weight: '500' }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ROAS',
                                font: { weight: '600' }
                            },
                            grid: { color: gridColor },
                            ticks: { callback: value => value.toFixed(1) + 'x' },
                            beginAtZero: true
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Revenue',
                                font: { weight: '600' }
                            },
                            grid: { color: gridColor },
                            ticks: { callback: value => '$' + (value / 1000).toFixed(0) + 'k' },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Profit by Campaign Chart
            const campaignsWithProfit = allCampaigns.map(c => ({
                name: c.name,
                platform: c.platform,
                profit: (c.revenue * metrics.margin) - c.spend
            })).sort((a, b) => b.profit - a.profit);
            
            if (campaignProfitChart) campaignProfitChart.destroy();
            const profitCtx = document.getElementById('campaignProfitChart').getContext('2d');
            campaignProfitChart = new Chart(profitCtx, {
                type: 'bar',
                data: {
                    labels: campaignsWithProfit.map(c => c.name.split(' ').slice(0, 4).join(' ')),
                    datasets: [{
                        label: 'Profit',
                        data: campaignsWithProfit.map(c => c.profit),
                        backgroundColor: campaignsWithProfit.map(c => 
                            c.profit >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                        ),
                        borderColor: campaignsWithProfit.map(c => 
                            c.profit >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'
                        ),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const prefix = value >= 0 ? '+$' : '-$';
                                    return `Profit: ${prefix}${Math.abs(value).toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: gridColor },
                            ticks: { 
                                callback: function(value) {
                                    const prefix = value >= 0 ? '$' : '-$';
                                    return prefix + Math.abs(value / 1000).toFixed(1) + 'k';
                                }
                            }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
            
            // Spend Efficiency Chart
            const totalSpend = allCampaigns.reduce((sum, c) => sum + c.spend, 0);
            const totalRevenue = allCampaigns.reduce((sum, c) => sum + c.revenue, 0);
            
            const efficiencyData = allCampaigns.map(c => ({
                name: c.name,
                platform: c.platform,
                spendShare: totalSpend > 0 ? (c.spend / totalSpend) * 100 : 0,
                revenueShare: totalRevenue > 0 ? (c.revenue / totalRevenue) * 100 : 0,
                efficiency: totalSpend > 0 && totalRevenue > 0 
                    ? ((c.revenue / totalRevenue) - (c.spend / totalSpend)) * 100 
                    : 0
            })).sort((a, b) => b.efficiency - a.efficiency);
            
            if (spendEfficiencyChart) spendEfficiencyChart.destroy();
            const effCtx = document.getElementById('spendEfficiencyChart').getContext('2d');
            spendEfficiencyChart = new Chart(effCtx, {
                type: 'bar',
                data: {
                    labels: efficiencyData.map(c => c.name.split(' ').slice(0, 4).join(' ')),
                    datasets: [{
                        label: 'Efficiency',
                        data: efficiencyData.map(c => c.efficiency),
                        backgroundColor: efficiencyData.map(c => 
                            c.efficiency >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(249, 115, 22, 0.8)'
                        ),
                        borderColor: efficiencyData.map(c => 
                            c.efficiency >= 0 ? 'rgba(59, 130, 246, 1)' : 'rgba(249, 115, 22, 1)'
                        ),
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const d = efficiencyData[idx];
                                    return [
                                        `Spend: ${d.spendShare.toFixed(1)}% of total`,
                                        `Revenue: ${d.revenueShare.toFixed(1)}% of total`,
                                        `${d.efficiency >= 0 ? '+' : ''}${d.efficiency.toFixed(1)}pp efficiency`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: gridColor },
                            ticks: { 
                                callback: function(value) {
                                    return (value >= 0 ? '+' : '') + value.toFixed(0) + 'pp';
                                }
                            }
                        },
                        y: { 
                            grid: { display: false },
                            ticks: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }
        
        function generateBudgetRecommendations(campaigns, metrics) {
            const container = document.getElementById('budgetRecommendations');
            const margin = parseFloat(document.getElementById('campaignMargin').value);
            const avgRoas = metrics.total.roas;
            const days = metrics.days;
            
            const sorted = campaigns.map(c => ({
                ...c,
                roas: c.revenue / c.spend,
                profit: (c.revenue * margin) - c.spend,
                spendPct: (c.spend / metrics.total.spend) * 100,
                dailySpend: c.spend / days
            })).sort((a, b) => b.roas - a.roas);
            
            let html = '';
            
            sorted.forEach(camp => {
                let action = '';
                let actionClass = '';
                let cardClass = '';
                let advice = '';
                
                if (camp.roas >= avgRoas * 1.5) {
                    action = 'INCREASE BUDGET';
                    actionClass = 'action-increase';
                    cardClass = 'winner';
                    const suggestedIncrease = Math.round(camp.dailySpend * 0.25);
                    const newDailyBudget = Math.round(camp.dailySpend + suggestedIncrease);
                    
                    advice = `<strong>Increase daily budget from $${Math.round(camp.dailySpend)} to $${newDailyBudget} (+$${suggestedIncrease}/day)</strong><br>
                             This campaign is performing ${((camp.roas - avgRoas) / avgRoas * 100).toFixed(0)}% above your average ROAS. 
                             Scaling this up could generate significant additional profit.`;
                } else if (camp.roas >= avgRoas * 1.2) {
                    action = 'INCREASE BUDGET';
                    actionClass = 'action-increase';
                    cardClass = 'winner';
                    const suggestedIncrease = Math.round(camp.dailySpend * 0.15);
                    const newDailyBudget = Math.round(camp.dailySpend + suggestedIncrease);
                    
                    advice = `<strong>Increase daily budget from $${Math.round(camp.dailySpend)} to $${newDailyBudget} (+$${suggestedIncrease}/day)</strong><br>
                             Solid performer with ${camp.roas.toFixed(2)}x ROAS. Room to scale while maintaining profitability.`;
                } else if (camp.roas >= metrics.breakevenRoas * 1.3) {
                    action = 'MAINTAIN';
                    actionClass = 'action-maintain';
                    cardClass = 'neutral';
                    
                    advice = `<strong>Keep current daily budget of $${Math.round(camp.dailySpend)}</strong><br>
                             Performing adequately at ${camp.roas.toFixed(2)}x ROAS. Monitor closely and optimize creative/targeting before scaling.`;
                } else if (camp.roas >= metrics.breakevenRoas) {
                    action = 'DECREASE BUDGET';
                    actionClass = 'action-decrease';
                    cardClass = 'loser';
                    const suggestedDecrease = Math.round(camp.dailySpend * 0.5);
                    const newDailyBudget = Math.round(camp.dailySpend - suggestedDecrease);
                    
                    advice = `<strong>Reduce daily budget from $${Math.round(camp.dailySpend)} to $${newDailyBudget} (-$${suggestedDecrease}/day)</strong><br>
                             Only ${camp.roas.toFixed(2)}x ROAS - barely profitable. Cut budget and test new creative/audiences before scaling back up.`;
                } else {
                    action = 'PAUSE CAMPAIGN';
                    actionClass = 'action-pause';
                    cardClass = 'loser';
                    
                    advice = `<strong>Pause this campaign immediately (currently spending $${Math.round(camp.dailySpend)}/day)</strong><br>
                             At ${camp.roas.toFixed(2)}x ROAS, you're losing money (break-even is ${metrics.breakevenRoas.toFixed(1)}x). 
                             Currently losing $${Math.abs(Math.round(camp.profit)).toLocaleString()} total. 
                             Pause, rework strategy, and relaunch with fresh creative.`;
                }
                
                html += `
                    <div class="metric-card" style="border-left: 4px solid ${cardClass === 'winner' ? '#10b981' : cardClass === 'loser' ? '#ef4444' : '#6b7280'}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${camp.name}</div>
                                <div style="font-size: 12px; color: #6b7280; text-transform: uppercase;">${camp.platform}</div>
                            </div>
                            <div class="status-badge ${actionClass === 'action-increase' ? 'status-good' : actionClass === 'action-decrease' ? 'status-poor' : actionClass === 'action-pause' ? 'status-poor' : 'status-okay'}">
                                ${action}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily Spend</div>
                                <div style="font-size: 15px; font-weight: 600;">${formatCurrency(camp.dailySpend)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">ROAS</div>
                                <div style="font-size: 15px; font-weight: 600; color: ${camp.roas >= metrics.breakevenRoas ? '#10b981' : '#ef4444'}">${camp.roas.toFixed(2)}x</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Total Profit</div>
                                <div style="font-size: 15px; font-weight: 600; color: ${camp.profit > 0 ? '#10b981' : '#ef4444'}">${formatCurrency(camp.profit)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Budget Share</div>
                                <div style="font-size: 15px; font-weight: 600;">${camp.spendPct.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 6px;">ðŸ“‹ Recommendation:</div>
                            <div style="font-size: 13px; color: #4b5563; line-height: 1.6;">${advice}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // BUSINESS OVERVIEW CODE
        // ==========================================
        
        function handleBusinessUpload(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('businessFileName').textContent = file.name;
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        businessData = parseBusinessData(results.data);
                        if (businessData.length === 0) {
                            alert('No valid data found in CSV. Please check your file format.');
                            return;
                        }
                        // Hide upload section and show dashboard
                        document.getElementById('businessUploadSection').style.display = 'none';
                        updateBusinessDashboard();
                    },
                    error: function(error) {
                        alert('Error parsing CSV: ' + error.message);
                    }
                });
            }
        }
        
        function parseBusinessData(data) {
            const months = [];
            
            data.forEach(row => {
                if (row['Month'] && row['Month'].trim() !== '' && row['Month'].trim() !== ',') {
                    const hasData = row['Google Spend'] || row['Google Revenue'] || 
                                   row['Meta Spend'] || row['Meta Revenue'] || 
                                   row['Website Sales'] || row['Total Business Sales'];
                    
                    if (hasData) {
                        // Handle both "Jan 2025" and "2025-01-25" date formats
                        let monthStr = row['Month'].trim();
                        if (monthStr.includes('-')) {
                            // Convert "2025-01-25" to "Jan 2025"
                            const date = new Date(monthStr);
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            monthStr = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
                        }
                        
                        months.push({
                            month: monthStr,
                            days: parseInt(row['Days']) || 30,
                            googleSpend: parseFloat(row['Google Spend']) || 0,
                            googleRevenue: parseFloat(row['Google Revenue']) || 0,
                            metaSpend: parseFloat(row['Meta Spend']) || 0,
                            metaRevenue: parseFloat(row['Meta Revenue']) || 0,
                            websiteSales: parseFloat(row['Website Sales']) || 0,
                            lucasSales: parseFloat(row['Lucas Sales']) || 0,
                            affiliateSales: parseFloat(row['Affiliate Sales']) || 0,
                            totalSales: parseFloat(row['Total Business Sales']) || 0,
                            traffic: parseFloat(row['Website Traffic']) || 0
                        });
                    }
                }
            });
            
            return months;
        }
        
        function updateBusinessDashboard() {
            if (!businessData || businessData.length === 0) return;
            
            const margin = parseFloat(document.getElementById('businessMargin').value);
            const currentMonth = businessData[businessData.length - 1];
            
            console.log('Current month data:', currentMonth);
            console.log('Month string:', currentMonth.month);
            
            document.getElementById('businessDashboardContent').classList.add('active');
            document.getElementById('businessPageSubtitle').textContent = `Latest: ${currentMonth.month} â€¢ ${(margin * 100)}% profit margin`;
            document.getElementById('currentMonthTitle').textContent = `Current Month Performance (${currentMonth.month})`;
            
            const totalAdSpend = currentMonth.googleSpend + currentMonth.metaSpend;
            const totalAdRevenue = currentMonth.googleRevenue + currentMonth.metaRevenue;
            const adGrossProfit = totalAdRevenue * margin;
            const adNetProfit = adGrossProfit - totalAdSpend;
            const adROAS = totalAdSpend > 0 ? totalAdRevenue / totalAdSpend : 0;
            const adROI = totalAdSpend > 0 ? (adNetProfit / totalAdSpend) * 100 : 0;
            
            // Use days from CSV data
            const daysInMonth = currentMonth.days || 30;
            
            // Calculate additional metrics
            const totalGrossProfit = currentMonth.totalSales * margin;
            const adSpendPercent = currentMonth.totalSales > 0 ? (totalAdSpend / currentMonth.totalSales) * 100 : 0;
            const revenuePerVisitor = currentMonth.traffic > 0 ? currentMonth.websiteSales / currentMonth.traffic : 0;
            const breakevenRoasCard = 1 / margin;
            const roasVsBreakeven = adROAS - breakevenRoasCard;
            
            // Current month cards
            let metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Business Sales</div>
                    <div class="metric-value">${formatCurrency(currentMonth.totalSales)}</div>
                    <div class="metric-subtext">${formatCurrency(currentMonth.totalSales / daysInMonth)}/day avg</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Gross Profit</div>
                    <div class="metric-value">${formatCurrency(totalGrossProfit)}</div>
                    <div class="metric-subtext">All channels at ${(margin * 100).toFixed(0)}% margin</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Net Profit</div>
                    <div class="metric-value ${adNetProfit >= 0 ? 'positive' : 'negative'}">${formatCurrency(adNetProfit)}</div>
                    <div class="metric-subtext">${adROI.toFixed(0)}% ROI on ad spend</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Blended ROAS</div>
                    <div class="metric-value ${adROAS >= breakevenRoasCard ? 'positive' : 'negative'}">${adROAS.toFixed(2)}x</div>
                    <div class="metric-subtext">${roasVsBreakeven >= 0 ? '+' : ''}${roasVsBreakeven.toFixed(2)}x vs ${breakevenRoasCard.toFixed(1)}x break-even</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Spend % of Revenue</div>
                    <div class="metric-value">${adSpendPercent.toFixed(1)}%</div>
                    <div class="metric-subtext">${formatCurrency(totalAdSpend)} of ${formatCurrency(currentMonth.totalSales)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Revenue per Visitor</div>
                    <div class="metric-value">$${revenuePerVisitor.toFixed(2)}</div>
                    <div class="metric-subtext">${currentMonth.traffic.toLocaleString()} visitors â†’ ${formatCurrency(currentMonth.websiteSales)}</div>
                </div>
            `;
            document.getElementById('businessMetrics').innerHTML = metricsHTML;
            
            // Google Ads stats
            const googleGrossProfit = currentMonth.googleRevenue * margin;
            const googleNetProfit = googleGrossProfit - currentMonth.googleSpend;
            const googleROAS = currentMonth.googleSpend > 0 ? currentMonth.googleRevenue / currentMonth.googleSpend : 0;
            const googleROI = currentMonth.googleSpend > 0 ? (googleNetProfit / currentMonth.googleSpend) * 100 : 0;
            
            // Meta Ads stats
            const metaGrossProfit = currentMonth.metaRevenue * margin;
            const metaNetProfit = metaGrossProfit - currentMonth.metaSpend;
            const metaROAS = currentMonth.metaSpend > 0 ? currentMonth.metaRevenue / currentMonth.metaSpend : 0;
            const metaROI = currentMonth.metaSpend > 0 ? (metaNetProfit / currentMonth.metaSpend) * 100 : 0;
            
            // Combined stats
            const breakevenRoas = 1 / margin;
            
            // Build comparison table
            const isDark = document.body.classList.contains('dark-mode');
            const headerBg = isDark ? '#374151' : '#f9fafb';
            const borderColor = isDark ? '#4b5563' : '#e5e7eb';
            
            document.getElementById('adComparisonTable').innerHTML = `
                <thead>
                    <tr style="background: ${headerBg};">
                        <th style="padding: 14px 16px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid ${borderColor};">Metric</th>
                        <th style="padding: 14px 16px; text-align: right; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid ${borderColor};">Google</th>
                        <th style="padding: 14px 16px; text-align: right; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid ${borderColor};">Meta</th>
                        <th style="padding: 14px 16px; text-align: right; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid ${borderColor};">Combined</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; font-weight: 500;">Spend</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right;">${formatCurrency(currentMonth.googleSpend)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right;">${formatCurrency(currentMonth.metaSpend)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; font-weight: 600;">${formatCurrency(totalAdSpend)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; font-weight: 500;">Revenue</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right;">${formatCurrency(currentMonth.googleRevenue)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right;">${formatCurrency(currentMonth.metaRevenue)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; font-weight: 600;">${formatCurrency(totalAdRevenue)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; font-weight: 500;">Net Profit</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; color: ${googleNetProfit >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(googleNetProfit)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; color: ${metaNetProfit >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(metaNetProfit)}</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; font-weight: 600; color: ${adNetProfit >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(adNetProfit)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; font-weight: 500;">ROAS</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; color: ${googleROAS >= breakevenRoas ? '#10b981' : '#ef4444'};">${googleROAS.toFixed(2)}x</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; color: ${metaROAS >= breakevenRoas ? '#10b981' : '#ef4444'};">${metaROAS.toFixed(2)}x</td>
                        <td style="padding: 12px 16px; border-bottom: 1px solid ${borderColor}; text-align: right; font-weight: 600; color: ${adROAS >= breakevenRoas ? '#10b981' : '#ef4444'};">${adROAS.toFixed(2)}x</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px 16px; font-weight: 500;">ROI</td>
                        <td style="padding: 12px 16px; text-align: right; color: ${googleROI >= 0 ? '#10b981' : '#ef4444'};">${googleROI.toFixed(0)}%</td>
                        <td style="padding: 12px 16px; text-align: right; color: ${metaROI >= 0 ? '#10b981' : '#ef4444'};">${metaROI.toFixed(0)}%</td>
                        <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: ${adROI >= 0 ? '#10b981' : '#ef4444'};">${adROI.toFixed(0)}%</td>
                    </tr>
                </tbody>
            `;
            
            document.getElementById('breakevenNote').textContent = `Break-even ROAS at ${(margin * 100).toFixed(0)}% margin = ${breakevenRoas.toFixed(2)}x Â· Green = profitable, Red = below break-even`;
            
            // Sales stats
            document.getElementById('websiteStats').innerHTML = `
                <div class="stat-row">
                    <span class="stat-label">Total Sales</span>
                    <span class="stat-value">${formatCurrency(currentMonth.websiteSales)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Daily Average</span>
                    <span class="stat-value">${formatCurrency(currentMonth.websiteSales / daysInMonth)}</span>
                </div>
            `;
            
            document.getElementById('lucasStats').innerHTML = `
                <div class="stat-row">
                    <span class="stat-label">Total Sales</span>
                    <span class="stat-value">${formatCurrency(currentMonth.lucasSales)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Daily Average</span>
                    <span class="stat-value">${formatCurrency(currentMonth.lucasSales / daysInMonth)}</span>
                </div>
            `;
            
            document.getElementById('affiliateStats').innerHTML = `
                <div class="stat-row">
                    <span class="stat-label">Total Sales</span>
                    <span class="stat-value">${formatCurrency(currentMonth.affiliateSales)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Daily Average</span>
                    <span class="stat-value">${formatCurrency(currentMonth.affiliateSales / daysInMonth)}</span>
                </div>
            `;
            
            createBusinessCharts();
        }
        
        function createBusinessCharts() {
            if (!businessData) return;
            
            const months = businessData.map(d => d.month);
            const margin = parseFloat(document.getElementById('businessMargin').value);
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#374151' : '#f3f4f6';
            const textColor = isDark ? '#9ca3af' : '#6b7280';
            
            Chart.defaults.font.family = "'Outfit', sans-serif";
            Chart.defaults.color = textColor;
            
            // Revenue trends chart
            if (revenueChart) revenueChart.destroy();
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Total Business',
                            data: businessData.map(d => d.totalSales),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Website Sales',
                            data: businessData.map(d => d.websiteSales),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Lucas Sales',
                            data: businessData.map(d => d.lucasSales),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Affiliate Sales',
                            data: businessData.map(d => d.affiliateSales),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': $' + context.parsed.y.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => '$' + (value / 1000).toFixed(0) + 'k'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
            
            // Ad spend & revenue chart (combo bar + line)
            if (adChart) adChart.destroy();
            const adCtx = document.getElementById('adChart').getContext('2d');
            const breakevenRoas = 1 / margin;
            
            adChart = new Chart(adCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Ad Revenue',
                            data: businessData.map(d => d.googleRevenue + d.metaRevenue),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Ad Spend',
                            data: businessData.map(d => d.googleSpend + d.metaSpend),
                            backgroundColor: 'rgba(249, 115, 22, 0.8)',
                            borderColor: 'rgba(249, 115, 22, 1)',
                            borderWidth: 1,
                            borderRadius: 4,
                            yAxisID: 'y',
                            order: 3
                        },
                        {
                            type: 'line',
                            label: 'ROAS',
                            data: businessData.map(d => {
                                const totalSpend = d.googleSpend + d.metaSpend;
                                const totalRevenue = d.googleRevenue + d.metaRevenue;
                                return totalSpend > 0 ? totalRevenue / totalSpend : 0;
                            }),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false,
                            yAxisID: 'y1',
                            pointRadius: 5,
                            pointBackgroundColor: '#3b82f6',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: context => {
                                    if (context.dataset.label === 'ROAS') {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + 'x';
                                    }
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                breakeven: {
                                    type: 'line',
                                    yMin: breakevenRoas,
                                    yMax: breakevenRoas,
                                    yScaleID: 'y1',
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: 'Break-even (' + breakevenRoas.toFixed(1) + 'x)',
                                        position: 'end',
                                        backgroundColor: '#ef4444',
                                        color: 'white',
                                        padding: 8,
                                        font: { size: 12, weight: '500' }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Revenue / Spend ($)',
                                font: { size: 12, weight: '500' }
                            },
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => '$' + (value / 1000).toFixed(0) + 'k'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ROAS (x)',
                                font: { size: 12, weight: '500' }
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: value => value.toFixed(1) + 'x'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
            
            // Traffic chart
            if (trafficChart) trafficChart.destroy();
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(trafficCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Website Visitors',
                        data: businessData.map(d => d.traffic),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => 'Visitors: ' + context.parsed.y.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => (value / 1000).toFixed(0) + 'k'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
        }
        
        // ==========================================
        // MONTHLY TRENDS CODE
        // ==========================================
        
        function updateTrendsDashboard() {
            if (!businessData || businessData.length < 2) {
                document.getElementById('trendsMetrics').innerHTML = '<p style="color: #6b7280;">Need at least 2 months of data to show trends.</p>';
                return;
            }
            
            const margin = parseFloat(document.getElementById('businessMargin').value);
            const currentMonth = businessData[businessData.length - 1];
            const lastMonth = businessData[businessData.length - 2];
            
            // Calculate changes
            const revenueChange = ((currentMonth.totalSales - lastMonth.totalSales) / lastMonth.totalSales) * 100;
            const trafficChange = ((currentMonth.traffic - lastMonth.traffic) / lastMonth.traffic) * 100;
            
            const currentAdSpend = currentMonth.googleSpend + currentMonth.metaSpend;
            const lastAdSpend = lastMonth.googleSpend + lastMonth.metaSpend;
            const currentAdRevenue = currentMonth.googleRevenue + currentMonth.metaRevenue;
            const lastAdRevenue = lastMonth.googleRevenue + lastMonth.metaRevenue;
            
            const currentRoas = currentAdSpend > 0 ? currentAdRevenue / currentAdSpend : 0;
            const lastRoas = lastAdSpend > 0 ? lastAdRevenue / lastAdSpend : 0;
            const roasChange = lastRoas > 0 ? ((currentRoas - lastRoas) / lastRoas) * 100 : 0;
            
            const adSpendChange = lastAdSpend > 0 ? ((currentAdSpend - lastAdSpend) / lastAdSpend) * 100 : 0;
            const adRevenueChange = lastAdRevenue > 0 ? ((currentAdRevenue - lastAdRevenue) / lastAdRevenue) * 100 : 0;
            
            const websiteSalesChange = lastMonth.websiteSales > 0 ? ((currentMonth.websiteSales - lastMonth.websiteSales) / lastMonth.websiteSales) * 100 : 0;
            
            document.getElementById('trendsPageSubtitle').textContent = `Comparing ${currentMonth.month} to ${lastMonth.month}`;
            
            function formatChange(value) {
                const arrow = value >= 0 ? 'â†‘' : 'â†“';
                const color = value >= 0 ? '#10b981' : '#ef4444';
                return `<span style="color: ${color}; font-weight: 600;">${arrow} ${Math.abs(value).toFixed(1)}%</span>`;
            }
            
            let metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">${formatCurrency(currentMonth.totalSales)}</div>
                    <div class="metric-subtext">${formatChange(revenueChange)} vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad ROAS</div>
                    <div class="metric-value">${currentRoas.toFixed(2)}x</div>
                    <div class="metric-subtext">${formatChange(roasChange)} vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Spend</div>
                    <div class="metric-value">${formatCurrency(currentAdSpend)}</div>
                    <div class="metric-subtext">${formatChange(adSpendChange)} vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Revenue</div>
                    <div class="metric-value">${formatCurrency(currentAdRevenue)}</div>
                    <div class="metric-subtext">${formatChange(adRevenueChange)} vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Website Traffic</div>
                    <div class="metric-value">${currentMonth.traffic.toLocaleString()}</div>
                    <div class="metric-subtext">${formatChange(trafficChange)} vs last month</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Website Sales</div>
                    <div class="metric-value">${formatCurrency(currentMonth.websiteSales)}</div>
                    <div class="metric-subtext">${formatChange(websiteSalesChange)} vs last month</div>
                </div>
            `;
            document.getElementById('trendsMetrics').innerHTML = metricsHTML;
            
            // Build summary table
            let tableHTML = `
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Total Revenue</th>
                        <th>Ad Spend</th>
                        <th>Ad Revenue</th>
                        <th>ROAS</th>
                        <th>Traffic</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            businessData.forEach((month, index) => {
                const adSpend = month.googleSpend + month.metaSpend;
                const adRevenue = month.googleRevenue + month.metaRevenue;
                const roas = adSpend > 0 ? adRevenue / adSpend : 0;
                
                tableHTML += `
                    <tr>
                        <td>${month.month}</td>
                        <td>${formatCurrency(month.totalSales)}</td>
                        <td>${formatCurrency(adSpend)}</td>
                        <td>${formatCurrency(adRevenue)}</td>
                        <td>${roas.toFixed(2)}x</td>
                        <td>${month.traffic.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            document.getElementById('trendsSummaryTable').innerHTML = tableHTML;
            
            createTrendsCharts();
        }
        
        function createTrendsCharts() {
            if (!businessData) return;
            
            const months = businessData.map(d => d.month);
            const margin = parseFloat(document.getElementById('businessMargin').value);
            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#374151' : '#f3f4f6';
            const textColor = isDark ? '#9ca3af' : '#6b7280';
            
            Chart.defaults.font.family = "'Outfit', sans-serif";
            Chart.defaults.color = textColor;
            
            // Revenue Trend Chart
            if (revenueTrendChart) revenueTrendChart.destroy();
            const revenueCtx = document.getElementById('revenueTrendChart').getContext('2d');
            revenueTrendChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Total Business Revenue',
                            data: businessData.map(d => d.totalSales),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Ad Revenue',
                            data: businessData.map(d => d.googleRevenue + d.metaRevenue),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': $' + context.parsed.y.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => '$' + (value / 1000).toFixed(0) + 'k'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
            
            // ROAS Trend Chart
            if (roasTrendChart) roasTrendChart.destroy();
            const roasCtx = document.getElementById('roasTrendChart').getContext('2d');
            const breakevenRoas = 1 / margin;
            roasTrendChart = new Chart(roasCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Blended ROAS',
                        data: businessData.map(d => {
                            const spend = d.googleSpend + d.metaSpend;
                            const revenue = d.googleRevenue + d.metaRevenue;
                            return spend > 0 ? revenue / spend : 0;
                        }),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                breakeven: {
                                    type: 'line',
                                    yMin: breakevenRoas,
                                    yMax: breakevenRoas,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: 'Break-even (' + breakevenRoas.toFixed(1) + 'x)',
                                        position: 'end',
                                        backgroundColor: '#ef4444',
                                        color: 'white',
                                        padding: 8,
                                        font: { size: 12, weight: '500' }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => value.toFixed(1) + 'x'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
            
            // Traffic Trend Chart
            if (trafficTrendChart) trafficTrendChart.destroy();
            const trafficCtx = document.getElementById('trafficTrendChart').getContext('2d');
            const avgTraffic = businessData.reduce((sum, d) => sum + d.traffic, 0) / businessData.length;
            trafficTrendChart = new Chart(trafficCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Website Visitors',
                        data: businessData.map(d => d.traffic),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => 'Visitors: ' + context.parsed.y.toLocaleString()
                            }
                        },
                        annotation: {
                            annotations: {
                                average: {
                                    type: 'line',
                                    yMin: avgTraffic,
                                    yMax: avgTraffic,
                                    borderColor: '#6b7280',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: 'Avg: ' + Math.round(avgTraffic).toLocaleString(),
                                        position: 'end',
                                        backgroundColor: '#6b7280',
                                        color: 'white',
                                        padding: 8,
                                        font: { size: 12, weight: '500' }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                callback: value => (value / 1000).toFixed(0) + 'k'
                            }
                        },
                        x: { grid: { color: gridColor } }
                    }
                }
            });
        }
        
        // ==========================================
        // FORECASTING CODE
        // ==========================================
        
        function updateForecastDashboard() {
            if (!businessData || businessData.length === 0) {
                document.getElementById('forecastMetrics').innerHTML = '<p style="color: #6b7280;">No business data available for forecasting.</p>';
                return;
            }
            
            const currentMonth = businessData[businessData.length - 1];
            const margin = parseFloat(document.getElementById('businessMargin').value);
            
            // Use days from CSV, calculate total days in month from month name
            let daysElapsed = currentMonth.days || 30;
            let totalDaysInMonth = 31;
            let monthName = currentMonth.month;
            
            try {
                const monthYear = currentMonth.month.split(' ');
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                const monthIndex = monthMap[monthYear[0]];
                const year = parseInt(monthYear[1]);
                
                if (monthIndex !== undefined && !isNaN(year)) {
                    totalDaysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                }
            } catch (e) {
                console.error('Error calculating days:', e);
            }
            
            const percentComplete = (daysElapsed / totalDaysInMonth) * 100;
            
            // Calculate daily averages and projections
            const dailyRevenue = currentMonth.totalSales / daysElapsed;
            const projectedRevenue = dailyRevenue * totalDaysInMonth;
            
            const currentAdSpend = currentMonth.googleSpend + currentMonth.metaSpend;
            const dailyAdSpend = currentAdSpend / daysElapsed;
            const projectedAdSpend = dailyAdSpend * totalDaysInMonth;
            
            const currentAdRevenue = currentMonth.googleRevenue + currentMonth.metaRevenue;
            const dailyAdRevenue = currentAdRevenue / daysElapsed;
            const projectedAdRevenue = dailyAdRevenue * totalDaysInMonth;
            
            const dailyTraffic = currentMonth.traffic / daysElapsed;
            const projectedTraffic = dailyTraffic * totalDaysInMonth;
            
            const projectedRoas = projectedAdSpend > 0 ? projectedAdRevenue / projectedAdSpend : 0;
            const projectedGrossProfit = projectedAdRevenue * margin;
            const projectedNetProfit = projectedGrossProfit - projectedAdSpend;
            
            document.getElementById('forecastPageSubtitle').textContent = 
                `${monthName} â€¢ Day ${daysElapsed} of ${totalDaysInMonth} â€¢ ${percentComplete.toFixed(0)}% complete`;
            
            // Progress bar
            const progressColor = percentComplete > 50 ? '#10b981' : '#3b82f6';
            document.getElementById('progressContainer').innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #6b7280;">
                    <span>Day ${daysElapsed}</span>
                    <span>Day ${totalDaysInMonth}</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 12px; height: 24px; overflow: hidden;">
                    <div style="background: ${progressColor}; height: 100%; width: ${percentComplete}%; border-radius: 12px; transition: width 0.5s ease;"></div>
                </div>
                <div style="text-align: center; margin-top: 8px; font-size: 14px; color: #6b7280;">
                    ${percentComplete.toFixed(0)}% through ${monthName}
                </div>
            `;
            
            // Forecast metrics
            let metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">${formatCurrency(projectedRevenue)}</div>
                    <div class="metric-subtext">Currently: ${formatCurrency(currentMonth.totalSales)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Revenue</div>
                    <div class="metric-value">${formatCurrency(projectedAdRevenue)}</div>
                    <div class="metric-subtext">Currently: ${formatCurrency(currentAdRevenue)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Spend</div>
                    <div class="metric-value">${formatCurrency(projectedAdSpend)}</div>
                    <div class="metric-subtext">Currently: ${formatCurrency(currentAdSpend)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Projected ROAS</div>
                    <div class="metric-value">${projectedRoas.toFixed(2)}x</div>
                    <div class="metric-subtext">Break-even: ${(1/margin).toFixed(1)}x</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Net Profit</div>
                    <div class="metric-value ${projectedNetProfit >= 0 ? 'positive' : ''}">${formatCurrency(projectedNetProfit)}</div>
                    <div class="metric-subtext">At ${(margin * 100).toFixed(0)}% margin</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Website Traffic</div>
                    <div class="metric-value">${Math.round(projectedTraffic).toLocaleString()}</div>
                    <div class="metric-subtext">Currently: ${currentMonth.traffic.toLocaleString()}</div>
                </div>
            `;
            document.getElementById('forecastMetrics').innerHTML = metricsHTML;
            
            // Projection details table
            const daysRemaining = totalDaysInMonth - daysElapsed;
            document.getElementById('projectionDetails').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Current</th>
                            <th>Daily Avg</th>
                            <th>Projected EOD</th>
                            <th>Remaining to Reach</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Revenue</td>
                            <td>${formatCurrency(currentMonth.totalSales)}</td>
                            <td>${formatCurrency(dailyRevenue)}</td>
                            <td>${formatCurrency(projectedRevenue)}</td>
                            <td>${formatCurrency(projectedRevenue - currentMonth.totalSales)}</td>
                        </tr>
                        <tr>
                            <td>Ad Revenue</td>
                            <td>${formatCurrency(currentAdRevenue)}</td>
                            <td>${formatCurrency(dailyAdRevenue)}</td>
                            <td>${formatCurrency(projectedAdRevenue)}</td>
                            <td>${formatCurrency(projectedAdRevenue - currentAdRevenue)}</td>
                        </tr>
                        <tr>
                            <td>Ad Spend</td>
                            <td>${formatCurrency(currentAdSpend)}</td>
                            <td>${formatCurrency(dailyAdSpend)}</td>
                            <td>${formatCurrency(projectedAdSpend)}</td>
                            <td>${formatCurrency(projectedAdSpend - currentAdSpend)}</td>
                        </tr>
                        <tr>
                            <td>Website Traffic</td>
                            <td>${currentMonth.traffic.toLocaleString()}</td>
                            <td>${Math.round(dailyTraffic).toLocaleString()}</td>
                            <td>${Math.round(projectedTraffic).toLocaleString()}</td>
                            <td>${Math.round(projectedTraffic - currentMonth.traffic).toLocaleString()}</td>
                        </tr>
                    </tbody>
                </table>
                <p style="color: #6b7280; margin-top: 16px; font-size: 14px;">
                    * Projections based on ${daysElapsed}-day average. ${daysRemaining} days remaining in ${monthName}.
                </p>
            `;
        }
        
        // ==========================================
        // EXECUTIVE SUMMARY CODE
        // ==========================================
        
        function updateSummaryDashboard() {
            if (!businessData || businessData.length === 0) {
                document.getElementById('summaryMetrics').innerHTML = '<p style="color: #6b7280;">No business data available.</p>';
                return;
            }
            
            const margin = parseFloat(document.getElementById('businessMargin').value);
            const breakevenRoas = 1 / margin;
            const currentMonth = businessData[businessData.length - 1];
            const lastMonth = businessData.length >= 2 ? businessData[businessData.length - 2] : null;
            
            // Current month calculations
            const currentAdSpend = currentMonth.googleSpend + currentMonth.metaSpend;
            const currentAdRevenue = currentMonth.googleRevenue + currentMonth.metaRevenue;
            const currentRoas = currentAdSpend > 0 ? currentAdRevenue / currentAdSpend : 0;
            const currentNetProfit = (currentAdRevenue * margin) - currentAdSpend;
            
            // Last month calculations for comparison
            let revenueChange = 0;
            let roasChange = 0;
            let trafficChange = 0;
            let adSpendChange = 0;
            
            if (lastMonth) {
                const lastAdSpend = lastMonth.googleSpend + lastMonth.metaSpend;
                const lastAdRevenue = lastMonth.googleRevenue + lastMonth.metaRevenue;
                const lastRoas = lastAdSpend > 0 ? lastAdRevenue / lastAdSpend : 0;
                
                revenueChange = lastMonth.totalSales > 0 ? ((currentMonth.totalSales - lastMonth.totalSales) / lastMonth.totalSales) * 100 : 0;
                roasChange = lastRoas > 0 ? ((currentRoas - lastRoas) / lastRoas) * 100 : 0;
                trafficChange = lastMonth.traffic > 0 ? ((currentMonth.traffic - lastMonth.traffic) / lastMonth.traffic) * 100 : 0;
                adSpendChange = lastAdSpend > 0 ? ((currentAdSpend - lastAdSpend) / lastAdSpend) * 100 : 0;
            }
            
            // Use days from CSV, calculate total days in month from month name
            let daysElapsed = currentMonth.days || 30;
            let totalDaysInMonth = 31;
            let monthName = currentMonth.month;
            
            try {
                const monthYear = currentMonth.month.split(' ');
                const monthMap = {
                    'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
                };
                const monthIndex = monthMap[monthYear[0]];
                const year = parseInt(monthYear[1]);
                
                if (monthIndex !== undefined && !isNaN(year)) {
                    totalDaysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                }
            } catch (e) {
                console.error('Error calculating days:', e);
            }
            
            // Projections
            const dailyRevenue = currentMonth.totalSales / daysElapsed;
            const projectedRevenue = dailyRevenue * totalDaysInMonth;
            const projectedAdRevenue = (currentAdRevenue / daysElapsed) * totalDaysInMonth;
            const projectedAdSpend = (currentAdSpend / daysElapsed) * totalDaysInMonth;
            const projectedNetProfit = (projectedAdRevenue * margin) - projectedAdSpend;
            
            document.getElementById('summaryPageSubtitle').textContent = `${monthName} â€¢ Day ${daysElapsed} of ${totalDaysInMonth}`;
            
            // Helper for status indicators
            function getStatusBadge(value, isGood) {
                if (isGood) {
                    return `<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">â†‘ ${Math.abs(value).toFixed(1)}%</span>`;
                } else {
                    return `<span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">â†“ ${Math.abs(value).toFixed(1)}%</span>`;
                }
            }
            
            function getRoasStatus(roas, breakeven) {
                if (roas >= breakeven * 1.5) {
                    return `<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Excellent</span>`;
                } else if (roas >= breakeven) {
                    return `<span style="background: #fef9c3; color: #854d0e; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Good</span>`;
                } else {
                    return `<span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Below Target</span>`;
                }
            }
            
            function getAdSpendStatus(percent) {
                if (percent < 5) {
                    return `<span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Lean</span>`;
                } else if (percent <= 12) {
                    return `<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Typical</span>`;
                } else if (percent <= 20) {
                    return `<span style="background: #fef9c3; color: #854d0e; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Growth</span>`;
                } else {
                    return `<span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Aggressive</span>`;
                }
            }
            
            // Key metrics
            const adSpendPercent = currentMonth.totalSales > 0 ? (currentAdSpend / currentMonth.totalSales) * 100 : 0;
            let lastAdSpendPercent = 0;
            let adSpendPercentChange = 0;
            if (lastMonth) {
                const lastTotalAdSpend = lastMonth.googleSpend + lastMonth.metaSpend;
                lastAdSpendPercent = lastMonth.totalSales > 0 ? (lastTotalAdSpend / lastMonth.totalSales) * 100 : 0;
                adSpendPercentChange = lastAdSpendPercent > 0 ? ((adSpendPercent - lastAdSpendPercent) / lastAdSpendPercent) * 100 : 0;
            }
            
            let metricsHTML = `
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">${formatCurrency(currentMonth.totalSales)}</div>
                    <div class="metric-subtext">${lastMonth ? getStatusBadge(revenueChange, revenueChange >= 0) + ' vs last month' : 'Current month'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad ROAS</div>
                    <div class="metric-value">${currentRoas.toFixed(2)}x</div>
                    <div class="metric-subtext">${getRoasStatus(currentRoas, breakevenRoas)} ${lastMonth ? getStatusBadge(roasChange, roasChange >= 0) + ' vs last month' : ''}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Net Profit</div>
                    <div class="metric-value ${currentNetProfit >= 0 ? 'positive' : ''}">${formatCurrency(currentNetProfit)}</div>
                    <div class="metric-subtext">At ${(margin * 100).toFixed(0)}% margin</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Ad Spend % of Revenue</div>
                    <div class="metric-value">${adSpendPercent.toFixed(1)}%</div>
                    <div class="metric-subtext">${getAdSpendStatus(adSpendPercent)} ${lastMonth ? getStatusBadge(adSpendPercentChange, adSpendPercentChange <= 0) + ' vs last month' : ''}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Website Traffic</div>
                    <div class="metric-value">${currentMonth.traffic.toLocaleString()}</div>
                    <div class="metric-subtext">${lastMonth ? getStatusBadge(trafficChange, trafficChange >= 0) + ' vs last month' : 'Current month'}</div>
                </div>
            `;
            document.getElementById('summaryMetrics').innerHTML = metricsHTML;
            
            // Forecast summary
            let forecastHTML = `
                <div class="metric-card">
                    <div class="metric-label">Projected Revenue</div>
                    <div class="metric-value">${formatCurrency(projectedRevenue)}</div>
                    <div class="metric-subtext">Based on ${daysElapsed}-day avg</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Projected Ad Profit</div>
                    <div class="metric-value ${projectedNetProfit >= 0 ? 'positive' : ''}">${formatCurrency(projectedNetProfit)}</div>
                    <div class="metric-subtext">End of month estimate</div>
                </div>
            `;
            document.getElementById('summaryForecast').innerHTML = forecastHTML;
            
            // Generate insights
            let insights = [];
            
            // ROAS insight
            if (currentRoas >= breakevenRoas * 1.5) {
                insights.push({ type: 'success', text: `ROAS is ${((currentRoas / breakevenRoas - 1) * 100).toFixed(0)}% above break-even â€” ads are highly profitable` });
            } else if (currentRoas >= breakevenRoas) {
                insights.push({ type: 'warning', text: `ROAS is ${((currentRoas / breakevenRoas - 1) * 100).toFixed(0)}% above break-even â€” ads are profitable but could improve` });
            } else {
                insights.push({ type: 'danger', text: `ROAS is ${((1 - currentRoas / breakevenRoas) * 100).toFixed(0)}% below break-even â€” ads are losing money` });
            }
            
            // Revenue trend
            if (lastMonth) {
                if (revenueChange >= 10) {
                    insights.push({ type: 'success', text: `Revenue up ${revenueChange.toFixed(1)}% vs last month â€” strong growth` });
                } else if (revenueChange >= 0) {
                    insights.push({ type: 'warning', text: `Revenue up ${revenueChange.toFixed(1)}% vs last month â€” steady` });
                } else {
                    insights.push({ type: 'danger', text: `Revenue down ${Math.abs(revenueChange).toFixed(1)}% vs last month` });
                }
            }
            
            // Traffic trend
            if (lastMonth) {
                if (trafficChange >= 10) {
                    insights.push({ type: 'success', text: `Traffic up ${trafficChange.toFixed(1)}% vs last month` });
                } else if (trafficChange >= 0) {
                    insights.push({ type: 'warning', text: `Traffic up ${trafficChange.toFixed(1)}% vs last month â€” slight increase` });
                } else {
                    insights.push({ type: 'danger', text: `Traffic down ${Math.abs(trafficChange).toFixed(1)}% vs last month â€” needs attention` });
                }
            }
            
            // Ad spend efficiency
            if (lastMonth && adSpendChange > 20 && roasChange < 0) {
                insights.push({ type: 'danger', text: `Ad spend up ${adSpendChange.toFixed(0)}% but ROAS declining â€” review campaign efficiency` });
            } else if (roasChange > 10) {
                insights.push({ type: 'success', text: `ROAS improved ${roasChange.toFixed(0)}% vs last month â€” campaigns getting more efficient` });
            }
            
            // Projection insight
            const percentComplete = (daysElapsed / totalDaysInMonth) * 100;
            const revenueProgress = lastMonth ? (currentMonth.totalSales / lastMonth.totalSales) * 100 : 0;
            if (lastMonth && revenueProgress > percentComplete) {
                insights.push({ type: 'success', text: `On pace to exceed last month's revenue by ${((projectedRevenue / lastMonth.totalSales - 1) * 100).toFixed(0)}%` });
            }
            
            // Meta vs Google comparison
            const metaSpend = currentMonth.metaSpend;
            const googleSpend = currentMonth.googleSpend;
            const metaRevenue = currentMonth.metaRevenue;
            const googleRevenue = currentMonth.googleRevenue;
            const metaRoas = metaSpend > 0 ? metaRevenue / metaSpend : 0;
            const googleRoas = googleSpend > 0 ? googleRevenue / googleSpend : 0;
            
            if (metaSpend > 0 && googleSpend > 0) {
                if (metaRoas > googleRoas * 1.2) {
                    insights.push({ type: 'success', text: `Meta (${metaRoas.toFixed(2)}x) is outperforming Google (${googleRoas.toFixed(2)}x) â€” consider shifting budget` });
                } else if (googleRoas > metaRoas * 1.2) {
                    insights.push({ type: 'success', text: `Google (${googleRoas.toFixed(2)}x) is outperforming Meta (${metaRoas.toFixed(2)}x) â€” consider shifting budget` });
                } else {
                    insights.push({ type: 'warning', text: `Meta (${metaRoas.toFixed(2)}x) and Google (${googleRoas.toFixed(2)}x) performing similarly` });
                }
            }
            
            // Best month context
            if (businessData.length >= 3) {
                const allRevenues = businessData.map(m => m.totalSales);
                const maxRevenue = Math.max(...allRevenues);
                const bestMonthIndex = allRevenues.indexOf(maxRevenue);
                const bestMonth = businessData[bestMonthIndex];
                
                if (currentMonth.totalSales === maxRevenue) {
                    insights.push({ type: 'success', text: `This is your best revenue month on record!` });
                } else {
                    const percentOfBest = (currentMonth.totalSales / maxRevenue) * 100;
                    if (percentOfBest >= 80) {
                        insights.push({ type: 'success', text: `Revenue is ${percentOfBest.toFixed(0)}% of your best month (${bestMonth.month}: ${formatCurrency(maxRevenue)})` });
                    } else if (percentOfBest >= 50) {
                        insights.push({ type: 'warning', text: `Revenue is ${percentOfBest.toFixed(0)}% of your best month (${bestMonth.month}: ${formatCurrency(maxRevenue)})` });
                    }
                }
            }
            
            // Channel breakdown
            const websitePercent = currentMonth.totalSales > 0 ? (currentMonth.websiteSales / currentMonth.totalSales) * 100 : 0;
            const lucasPercent = currentMonth.totalSales > 0 ? (currentMonth.lucasSales / currentMonth.totalSales) * 100 : 0;
            const affiliatePercent = currentMonth.totalSales > 0 ? (currentMonth.affiliateSales / currentMonth.totalSales) * 100 : 0;
            
            // Find the dominant channel
            const channels = [
                { name: 'Website', percent: websitePercent, sales: currentMonth.websiteSales },
                { name: 'Lucas', percent: lucasPercent, sales: currentMonth.lucasSales },
                { name: 'Affiliate', percent: affiliatePercent, sales: currentMonth.affiliateSales }
            ].sort((a, b) => b.percent - a.percent);
            
            insights.push({ type: 'warning', text: `Channel mix: ${channels[0].name} ${channels[0].percent.toFixed(0)}%, ${channels[1].name} ${channels[1].percent.toFixed(0)}%, ${channels[2].name} ${channels[2].percent.toFixed(0)}%` });
            
            // Channel trend vs last month
            if (lastMonth) {
                const lastLucasPercent = lastMonth.totalSales > 0 ? (lastMonth.lucasSales / lastMonth.totalSales) * 100 : 0;
                const lastAffiliatePercent = lastMonth.totalSales > 0 ? (lastMonth.affiliateSales / lastMonth.totalSales) * 100 : 0;
                
                const lucasChange = lastMonth.lucasSales > 0 ? ((currentMonth.lucasSales - lastMonth.lucasSales) / lastMonth.lucasSales) * 100 : 0;
                const affiliateChange = lastMonth.affiliateSales > 0 ? ((currentMonth.affiliateSales - lastMonth.affiliateSales) / lastMonth.affiliateSales) * 100 : 0;
                
                if (lucasChange > 20) {
                    insights.push({ type: 'success', text: `Lucas channel up ${lucasChange.toFixed(0)}% vs last month` });
                } else if (lucasChange < -20) {
                    insights.push({ type: 'danger', text: `Lucas channel down ${Math.abs(lucasChange).toFixed(0)}% vs last month` });
                }
                
                if (affiliateChange > 20) {
                    insights.push({ type: 'success', text: `Affiliate channel up ${affiliateChange.toFixed(0)}% vs last month` });
                } else if (affiliateChange < -20) {
                    insights.push({ type: 'danger', text: `Affiliate channel down ${Math.abs(affiliateChange).toFixed(0)}% vs last month` });
                }
            }
            
            let insightsHTML = '<div style="display: flex; flex-direction: column; gap: 12px;">';
            insights.forEach(insight => {
                let icon, bgColor, textColor;
                if (insight.type === 'success') {
                    icon = 'âœ“';
                    bgColor = '#dcfce7';
                    textColor = '#166534';
                } else if (insight.type === 'warning') {
                    icon = 'â—';
                    bgColor = '#fef9c3';
                    textColor = '#854d0e';
                } else {
                    icon = 'âš ';
                    bgColor = '#fee2e2';
                    textColor = '#991b1b';
                }
                
                insightsHTML += `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: ${bgColor}; border-radius: 12px;">
                        <span style="font-size: 18px; color: ${textColor};">${icon}</span>
                        <span style="color: ${textColor}; font-weight: 500;">${insight.text}</span>
                    </div>
                `;
            });
            insightsHTML += '</div>';
            
            document.getElementById('summaryInsights').innerHTML = insightsHTML;
            
            // Create health radar chart
            createHealthRadarChart(currentMonth, lastMonth, margin, breakevenRoas);
        }
        
        function createHealthRadarChart(currentMonth, lastMonth, margin, breakevenRoas) {
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            // Calculate scores (0-100 scale)
            const currentAdSpend = currentMonth.googleSpend + currentMonth.metaSpend;
            const currentAdRevenue = currentMonth.googleRevenue + currentMonth.metaRevenue;
            const currentRoas = currentAdSpend > 0 ? currentAdRevenue / currentAdSpend : 0;
            
            // ROAS Score: 0 at 0x, 50 at break-even, 100 at 2x break-even
            const roasScore = Math.min(100, Math.max(0, (currentRoas / (breakevenRoas * 2)) * 100));
            
            // Revenue Growth Score: Compare to last month
            let revenueScore = 50; // default if no comparison
            if (lastMonth && lastMonth.totalSales > 0) {
                const revenueChange = ((currentMonth.totalSales - lastMonth.totalSales) / lastMonth.totalSales) * 100;
                // -20% = 0, 0% = 50, +20% = 100
                revenueScore = Math.min(100, Math.max(0, 50 + (revenueChange * 2.5)));
            }
            
            // Traffic Score: Compare to last month
            let trafficScore = 50;
            if (lastMonth && lastMonth.traffic > 0) {
                const trafficChange = ((currentMonth.traffic - lastMonth.traffic) / lastMonth.traffic) * 100;
                trafficScore = Math.min(100, Math.max(0, 50 + (trafficChange * 2.5)));
            }
            
            // Ad Efficiency Score: Based on ad spend % of revenue (lower is better)
            const adSpendPercent = currentMonth.totalSales > 0 ? (currentAdSpend / currentMonth.totalSales) * 100 : 0;
            // 0% spend = 100, 10% = 75, 20% = 50, 30% = 25, 40%+ = 0
            const efficiencyScore = Math.min(100, Math.max(0, 100 - (adSpendPercent * 2.5)));
            
            // Channel Diversity Score: How balanced are Website/Lucas/Affiliate
            const websitePercent = currentMonth.totalSales > 0 ? (currentMonth.websiteSales / currentMonth.totalSales) : 0;
            const lucasPercent = currentMonth.totalSales > 0 ? (currentMonth.lucasSales / currentMonth.totalSales) : 0;
            const affiliatePercent = currentMonth.totalSales > 0 ? (currentMonth.affiliateSales / currentMonth.totalSales) : 0;
            // Perfect balance would be 33% each. Measure deviation from that.
            const idealShare = 1/3;
            const deviation = Math.abs(websitePercent - idealShare) + Math.abs(lucasPercent - idealShare) + Math.abs(affiliatePercent - idealShare);
            // Max deviation is ~1.33, so normalize: 0 deviation = 100, max = 0
            const diversityScore = Math.max(0, 100 - (deviation * 75));
            
            // Profit Score: Based on net profit margin from ads
            const netProfit = (currentAdRevenue * margin) - currentAdSpend;
            const profitMarginOnAds = currentAdSpend > 0 ? (netProfit / currentAdSpend) * 100 : 0;
            // -50% = 0, 0% = 50, +50% = 100
            const profitScore = Math.min(100, Math.max(0, 50 + profitMarginOnAds));
            
            const ctx = document.getElementById('healthRadarChart').getContext('2d');
            
            if (healthRadarChart) {
                healthRadarChart.destroy();
            }
            
            healthRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ROAS', 'Revenue Growth', 'Traffic', 'Ad Efficiency', 'Channel Mix', 'Profitability'],
                    datasets: [{
                        label: 'Business Health',
                        data: [roasScore, revenueScore, trafficScore, efficiencyScore, diversityScore, profitScore],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw.toFixed(0) + '/100';
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: {
                                stepSize: 25,
                                display: false
                            },
                            grid: {
                                color: gridColor
                            },
                            angleLines: {
                                color: gridColor
                            },
                            pointLabels: {
                                color: textColor,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Auto-load CSV on page load
        function autoLoadBusinessData() {
            fetch('All_Business_Data_for_Dashboard.csv')
                .then(response => {
                    if (!response.ok) {
                        console.log('No default business CSV found, showing upload screen');
                        return;
                    }
                    return response.text();
                })
                .then(csvText => {
                    if (csvText) {
                        Papa.parse(csvText, {
                            header: true,
                            complete: function(results) {
                                businessData = parseBusinessData(results.data);
                                if (businessData.length > 0) {
                                    // Hide upload section and show dashboard
                                    document.getElementById('businessUploadSection').style.display = 'none';
                                    updateBusinessDashboard();
                                    console.log('Auto-loaded business data from CSV');
                                }
                            },
                            error: function(error) {
                                console.error('Error parsing auto-loaded CSV:', error);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.log('Business CSV auto-load failed (this is ok if manually uploading):', error);
                });
        }
        
        // Auto-load combined Ad Campaign data
        function autoLoadCampaignData() {
            fetch('Ad_Campaign_Data.csv')
                .then(response => {
                    if (!response.ok) {
                        console.log('No default Ad Campaign CSV found');
                        return;
                    }
                    return response.text();
                })
                .then(csvText => {
                    if (csvText) {
                        Papa.parse(csvText, {
                            header: true,
                            complete: function(results) {
                                const parsed = parseCombinedCampaignData(results.data);
                                metaData = parsed.metaData;
                                googleData = parsed.googleData;
                                console.log('Auto-loaded combined Ad Campaign data');
                                if (metaData && googleData) {
                                    document.getElementById('campaignUploadSection').style.display = 'none';
                                    updateCampaignDashboard();
                                }
                            },
                            error: function(error) {
                                console.error('Error parsing Ad Campaign CSV:', error);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.log('Ad Campaign CSV auto-load failed:', error);
                });
        }
        
        // Run auto-load when page loads
        window.addEventListener('DOMContentLoaded', function() {
            autoLoadBusinessData();
            autoLoadCampaignData();
        });
        
        // ==========================================
        // AI CHAT FUNCTIONALITY
        // ==========================================
        
        let chatHistory = [];
        
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            const toggle = document.getElementById('chatToggle');
            panel.classList.toggle('open');
            toggle.classList.toggle('active');
            
            if (panel.classList.contains('open')) {
                document.getElementById('chatInput').focus();
            }
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        function buildDataContext() {
            const margin = parseFloat(document.getElementById('businessMargin')?.value || 0.6);
            let context = "Current dashboard data:\n\n";
            
            if (businessData && businessData.length > 0) {
                const current = businessData[businessData.length - 1];
                const totalAdSpend = current.googleSpend + current.metaSpend;
                const totalAdRevenue = current.googleRevenue + current.metaRevenue;
                const adNetProfit = (totalAdRevenue * margin) - totalAdSpend;
                const adROAS = totalAdSpend > 0 ? totalAdRevenue / totalAdSpend : 0;
                const breakevenRoas = 1 / margin;
                
                context += `CURRENT MONTH (${current.month}):\n`;
                context += `- Total Business Sales: $${current.totalSales.toLocaleString()}\n`;
                context += `- Website Sales: $${current.websiteSales.toLocaleString()}\n`;
                context += `- Lucas Sales: $${current.lucasSales.toLocaleString()}\n`;
                context += `- Affiliate Sales: $${current.affiliateSales.toLocaleString()}\n`;
                context += `- Website Traffic: ${current.traffic.toLocaleString()} visitors\n`;
                context += `- Days in period: ${current.days}\n\n`;
                
                context += `ADVERTISING (${current.month}):\n`;
                context += `- Google Ads: Spend $${current.googleSpend.toLocaleString()}, Revenue $${current.googleRevenue.toLocaleString()}, ROAS ${(current.googleSpend > 0 ? current.googleRevenue / current.googleSpend : 0).toFixed(2)}x\n`;
                context += `- Meta Ads: Spend $${current.metaSpend.toLocaleString()}, Revenue $${current.metaRevenue.toLocaleString()}, ROAS ${(current.metaSpend > 0 ? current.metaRevenue / current.metaSpend : 0).toFixed(2)}x\n`;
                context += `- Combined: Spend $${totalAdSpend.toLocaleString()}, Revenue $${totalAdRevenue.toLocaleString()}, ROAS ${adROAS.toFixed(2)}x\n`;
                context += `- Ad Net Profit: $${adNetProfit.toLocaleString()}\n`;
                context += `- Break-even ROAS at ${(margin * 100)}% margin: ${breakevenRoas.toFixed(2)}x\n\n`;
                
                if (businessData.length > 1) {
                    const prev = businessData[businessData.length - 2];
                    const salesChange = ((current.totalSales - prev.totalSales) / prev.totalSales * 100).toFixed(1);
                    const trafficChange = ((current.traffic - prev.traffic) / prev.traffic * 100).toFixed(1);
                    context += `MONTH-OVER-MONTH CHANGE:\n`;
                    context += `- Previous month (${prev.month}): $${prev.totalSales.toLocaleString()} in sales, ${prev.traffic.toLocaleString()} traffic\n`;
                    context += `- Sales change: ${salesChange}%\n`;
                    context += `- Traffic change: ${trafficChange}%\n\n`;
                }
                
                context += `HISTORICAL DATA (${businessData.length} months):\n`;
                businessData.forEach(m => {
                    const mSpend = (m.googleSpend || 0) + (m.metaSpend || 0);
                    const mRev = (m.googleRevenue || 0) + (m.metaRevenue || 0);
                    const mRoas = mSpend > 0 ? (mRev / mSpend).toFixed(2) : 'N/A';
                    const sales = m.totalSales || 0;
                    const traffic = m.traffic || 0;
                    context += `- ${m.month}: Sales $${sales.toLocaleString()}, Ad Spend $${mSpend.toLocaleString()}, Ad Revenue $${mRev.toLocaleString()}, ROAS ${mRoas}x, Traffic ${traffic.toLocaleString()}\n`;
                });
            }
            
            if (metaData && metaData.campaigns && metaData.campaigns.length > 0) {
                context += `\nMETA CAMPAIGNS:\n`;
                metaData.campaigns.forEach(c => {
                    const cost = c.cost || 0;
                    const revenue = c.revenue || 0;
                    const clicks = c.clicks || 0;
                    const roas = cost > 0 ? (revenue / cost).toFixed(2) : 'N/A';
                    context += `- ${c.name || 'Unknown'}: Spend $${cost.toLocaleString()}, Revenue $${revenue.toLocaleString()}, ROAS ${roas}x, Clicks ${clicks.toLocaleString()}\n`;
                });
            }
            
            if (googleData && googleData.campaigns && googleData.campaigns.length > 0) {
                context += `\nGOOGLE CAMPAIGNS:\n`;
                googleData.campaigns.forEach(c => {
                    const cost = c.cost || 0;
                    const revenue = c.revenue || 0;
                    const clicks = c.clicks || 0;
                    const roas = cost > 0 ? (revenue / cost).toFixed(2) : 'N/A';
                    context += `- ${c.name || 'Unknown'}: Spend $${cost.toLocaleString()}, Revenue $${revenue.toLocaleString()}, ROAS ${roas}x, Clicks ${clicks.toLocaleString()}\n`;
                });
            }
            
            return context;
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const sendBtn = document.getElementById('chatSend');
            const messagesContainer = document.getElementById('chatMessages');
            
            // Add user message
            messagesContainer.innerHTML += `
                <div class="chat-message user">
                    <div class="message-content">${escapeHtml(message)}</div>
                </div>
            `;
            
            // Clear input and disable
            input.value = '';
            sendBtn.disabled = true;
            
            // Add loading message
            const loadingId = 'loading-' + Date.now();
            messagesContainer.innerHTML += `
                <div class="chat-message assistant loading" id="${loadingId}">
                    <div class="message-content">Thinking</div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Build context and chat history
            const dataContext = buildDataContext();
            chatHistory.push({ role: 'user', content: message });
            
            const systemPrompt = `You are a helpful AI assistant for the Aerovex business dashboard. You help users understand their business metrics, advertising performance, and trends.

${dataContext}

Guidelines:
- Be concise and actionable in your responses
- Use specific numbers from the data when relevant
- Highlight important insights (good or concerning)
- If asked about something not in the data, say so
- Keep responses focused and under 150 words unless asked for detail
- Use plain language, avoid jargon
- Format currency as $X,XXX and percentages as X.X%`;

            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system: systemPrompt,
                        messages: chatHistory
                    })
                });
                
                const data = await response.json();
                const assistantMessage = data.content?.[0]?.text || 'Sorry, I had trouble processing that. Please try again.';
                
                // Add to history
                chatHistory.push({ role: 'assistant', content: assistantMessage });
                
                // Replace loading with response
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.classList.remove('loading');
                    loadingEl.querySelector('.message-content').innerHTML = formatChatResponse(assistantMessage);
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) {
                    loadingEl.classList.remove('loading');
                    loadingEl.querySelector('.message-content').textContent = 'Sorry, I couldn\'t connect. Please try again.';
                }
            }
            
            sendBtn.disabled = false;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatChatResponse(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }
    </script>
</body>
</html>
